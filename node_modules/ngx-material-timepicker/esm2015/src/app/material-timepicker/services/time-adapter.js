import { DateTime } from 'luxon';
import { TimeFormat } from '../models/time-format.enum';
import { TimePeriod } from '../models/time-period.enum';
import { isBetween, isSameOrAfter, isSameOrBefore } from '../utils/timepicker.utils';
// @dynamic
export class TimeAdapter {
    static parseTime(time, opts) {
        const { numberingSystem, locale } = TimeAdapter.getLocaleOptionsByTime(time, opts);
        const isPeriodExist = time.split(' ').length === 2;
        const timeMask = isPeriodExist ? TimeFormat.TWELVE_SHORT : TimeFormat.TWENTY_FOUR_SHORT;
        return DateTime.fromFormat(time, timeMask, { numberingSystem, locale });
    }
    static formatTime(time, opts) {
        if (!time) {
            return 'Invalid Time';
        }
        const { format } = opts;
        const parsedTime = TimeAdapter.parseTime(time, opts).setLocale(TimeAdapter.DEFAULT_LOCALE);
        if (format !== 24) {
            return parsedTime.toLocaleString(Object.assign({}, DateTime.TIME_SIMPLE, { hour12: format !== 24, numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM })).replace(/\u200E/g, '').replace(/\u202F/g, ' ');
        }
        return parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        }).replace(/\u200E/g, '').replace(/\u202F/g, ' ');
    }
    static toLocaleTimeString(time, opts = {}) {
        const { format = TimeAdapter.DEFAULT_FORMAT, locale = TimeAdapter.DEFAULT_LOCALE } = opts;
        const hourCycle = format === 24 ? 'h23' : 'h12';
        const timeFormat = Object.assign({}, DateTime.TIME_SIMPLE, { hourCycle });
        const timeMask = (format === 24) ? TimeFormat.TWENTY_FOUR_SHORT : TimeFormat.TWELVE_SHORT;
        const localOpts = Object.assign({ locale: opts.locale, numberingSystem: opts.numberingSystem }, timeFormat);
        return DateTime.fromFormat(time, timeMask).setLocale(locale).toLocaleString(localOpts).replace(/\u202F/g, ' ');
    }
    static isTimeAvailable(time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return;
        }
        const convertedTime = this.parseTime(time, { format });
        const minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error(`Your minutes - ${minutes} doesn\'t match your minutesGap - ${minutesGap}`);
        }
        const isAfter = (min && !max)
            && isSameOrAfter(convertedTime, min, granularity);
        const isBefore = (max && !min)
            && isSameOrBefore(convertedTime, max, granularity);
        const between = (min && max)
            && isBetween(convertedTime, min, max, granularity);
        const isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    }
    /***
     *  Format hour according to time format (12 or 24)
     */
    static formatHour(currentHour, format, period) {
        if (format === 24) {
            return currentHour;
        }
        const hour = period === TimePeriod.AM ? currentHour : currentHour + 12;
        if (period === TimePeriod.AM && hour === 12) {
            return 0;
        }
        else if (period === TimePeriod.PM && hour === 24) {
            return 12;
        }
        return hour;
    }
    static fromDateTimeToString(time, format) {
        const timeFormat = format === 24 ? TimeFormat.TWENTY_FOUR : TimeFormat.TWELVE;
        return time.reconfigure({
            numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM,
            locale: TimeAdapter.DEFAULT_LOCALE
        }).toFormat(timeFormat).replace(/\u202F/g, ' ');
    }
    static getLocaleOptionsByTime(time, opts) {
        const localeConfig = { numberingSystem: opts.numberingSystem, locale: opts.locale };
        const defaultConfig = { numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM, locale: TimeAdapter.DEFAULT_LOCALE };
        return isNaN(parseInt(time, 10)) ? localeConfig : defaultConfig;
    }
}
TimeAdapter.DEFAULT_FORMAT = 12;
TimeAdapter.DEFAULT_LOCALE = 'en-US';
TimeAdapter.DEFAULT_NUMBERING_SYSTEM = 'latn';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW1hdGVyaWFsLXRpbWVwaWNrZXIvIiwic291cmNlcyI6WyJzcmMvYXBwL21hdGVyaWFsLXRpbWVwaWNrZXIvc2VydmljZXMvdGltZS1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQWlCLE1BQU0sT0FBTyxDQUFDO0FBRWhELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFHckYsV0FBVztBQUNYLE1BQU0sT0FBTyxXQUFXO0lBS3BCLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBWSxFQUFFLElBQWlCO1FBQzVDLE1BQU0sRUFBQyxlQUFlLEVBQUUsTUFBTSxFQUFDLEdBQUcsV0FBVyxDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNqRixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUM7UUFFeEYsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBQyxlQUFlLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFZLEVBQUUsSUFBaUI7UUFDN0MsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLE9BQU8sY0FBYyxDQUFDO1NBQ3pCO1FBQ0QsTUFBTSxFQUFDLE1B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QUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFTyxNQUFNLENBQUMsc0JBQXNCLENBQUMsSUFBWSxFQUFFLElBQWlCO1FBQ2pFLE1BQU0sWUFBWSxHQUFrQixFQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFDLENBQUM7UUFDakcsTUFBTSxhQUFhLEdBQWtCLEVBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyx3QkFBd0IsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLGNBQWMsRUFBQyxDQUFDO1FBRWpJLE9BQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7SUFDcEUsQ0FBQzs7QUF0R00sMEJBQWMsR0FBRyxFQUFFLENBQUM7QUFDcEIsMEJBQWMsR0FBRyxPQUFPLENBQUM7QUFDekIsb0NBQXdCLEdBQUcsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0ZVRpbWUsIExvY2FsZU9wdGlvbnMgfSBmcm9tICdsdXhvbic7XG5cbmltcG9ydCB7IFRpbWVGb3JtYXQgfSBmcm9tICcuLi9tb2RlbHMvdGltZS1mb3JtYXQuZW51bSc7XG5pbXBvcnQgeyBUaW1lUGVyaW9kIH0gZnJvbSAnLi4vbW9kZWxzL3RpbWUtcGVyaW9kLmVudW0nO1xuaW1wb3J0IHsgaXNCZXR3ZWVuLCBpc1NhbWVPckFmdGVyLCBpc1NhbWVPckJlZm9yZSB9IGZyb20gJy4uL3V0aWxzL3RpbWVwaWNrZXIudXRpbHMnO1xuaW1wb3J0IHsgVGltZU9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbHMvdGltZS1vcHRpb25zLmludGVyZmFjZSc7XG5cbi8vIEBkeW5hbWljXG5leHBvcnQgY2xhc3MgVGltZUFkYXB0ZXIge1xuICAgIHN0YXRpYyBERUZBVUxUX0ZPUk1BVCA9IDEyO1xuICAgIHN0YXRpYyBERUZBVUxUX0xPQ0FMRSA9ICdlbi1VUyc7XG4gICAgc3RhdGljIERFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTSA9ICdsYXRuJztcblxuICAgIHN0YXRpYyBwYXJzZVRpbWUodGltZTogc3RyaW5nLCBvcHRzOiBUaW1lT3B0aW9ucyk6IERhdGVUaW1lIHtcbiAgICAgICAgY29uc3Qge251bWJlcmluZ1N5c3RlbSwgbG9jYWxlfSA9IFRpbWVBZGFwdGVyLmdldExvY2FsZU9wdGlvbnNCeVRpbWUodGltZSwgb3B0cyk7XG4gICAgICAgIGNvbnN0IGlzUGVyaW9kRXhpc3QgPSB0aW1lLnNwbGl0KCcgJykubGVuZ3RoID09PSAyO1xuICAgICAgICBjb25zdCB0aW1lTWFzayA9IGlzUGVyaW9kRXhpc3QgPyBUaW1lRm9ybWF0LlRXRUxWRV9TSE9SVCA6IFRpbWVGb3JtYXQuVFdFTlRZX0ZPVVJfU0hPUlQ7XG5cbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2ssIHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBmb3JtYXRUaW1lKHRpbWU6IHN0cmluZywgb3B0czogVGltZU9wdGlvbnMpOiBzdHJpbmcge1xuICAgICAgICBpZiAoIXRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiAnSW52YWxpZCBUaW1lJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7Zm9ybWF0fSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IHBhcnNlZFRpbWUgPSBUaW1lQWRhcHRlci5wYXJzZVRpbWUodGltZSwgb3B0cykuc2V0TG9jYWxlKFRpbWVBZGFwdGVyLkRFRkFVTFRfTE9DQUxFKTtcblxuICAgICAgICBpZiAoZm9ybWF0ICE9PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcnNlZFRpbWUudG9Mb2NhbGVTdHJpbmcoe1xuICAgICAgICAgICAgICAgIC4uLkRhdGVUaW1lLlRJTUVfU0lNUExFLFxuICAgICAgICAgICAgICAgIGhvdXIxMjogZm9ybWF0ICE9PSAyNCxcbiAgICAgICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IFRpbWVBZGFwdGVyLkRFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTVxuICAgICAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCAnJykucmVwbGFjZSgvXFx1MjAyRi9nLCAnICcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJzZWRUaW1lLnRvSVNPVGltZSh7XG4gICAgICAgICAgICBpbmNsdWRlT2Zmc2V0OiBmYWxzZSxcbiAgICAgICAgICAgIHN1cHByZXNzTWlsbGlzZWNvbmRzOiB0cnVlLFxuICAgICAgICAgICAgc3VwcHJlc3NTZWNvbmRzOiB0cnVlXG4gICAgICAgIH0pLnJlcGxhY2UoL1xcdTIwMEUvZywgJycpLnJlcGxhY2UoL1xcdTIwMkYvZywgJyAnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9Mb2NhbGVUaW1lU3RyaW5nKHRpbWU6IHN0cmluZywgb3B0czogVGltZU9wdGlvbnMgPSB7fSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHtmb3JtYXQgPSBUaW1lQWRhcHRlci5ERUZBVUxUX0ZPUk1BVCwgbG9jYWxlID0gVGltZUFkYXB0ZXIuREVGQVVMVF9MT0NBTEV9ID0gb3B0cztcbiAgICAgICAgY29uc3QgaG91ckN5Y2xlID0gZm9ybWF0ID09PSAyNCA/ICdoMjMnIDogJ2gxMic7XG4gICAgICAgIGNvbnN0IHRpbWVGb3JtYXQgPSB7Li4uRGF0ZVRpbWUuVElNRV9TSU1QTEUsIGhvdXJDeWNsZX07XG4gICAgICAgIGNvbnN0IHRpbWVNYXNrID0gKGZvcm1hdCA9PT0gMjQpID8gVGltZUZvcm1hdC5UV0VOVFlfRk9VUl9TSE9SVCA6IFRpbWVGb3JtYXQuVFdFTFZFX1NIT1JUO1xuICAgICAgICBjb25zdCBsb2NhbE9wdHMgPSB7IGxvY2FsZTogb3B0cy5sb2NhbGUsIG51bWJlcmluZ1N5c3RlbTogb3B0cy5udW1iZXJpbmdTeXN0ZW0sIC4uLnRpbWVGb3JtYXQgfTtcbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2spLnNldExvY2FsZShsb2NhbGUpLnRvTG9jYWxlU3RyaW5nKGxvY2FsT3B0cykucmVwbGFjZSgvXFx1MjAyRi9nLCAnICcpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc1RpbWVBdmFpbGFibGUoXG4gICAgICAgIHRpbWU6IHN0cmluZyxcbiAgICAgICAgbWluPzogRGF0ZVRpbWUsXG4gICAgICAgIG1heD86IERhdGVUaW1lLFxuICAgICAgICBncmFudWxhcml0eT86ICdob3VycycgfCAnbWludXRlcycsXG4gICAgICAgIG1pbnV0ZXNHYXA/OiBudW1iZXIgfCBudWxsLFxuICAgICAgICBmb3JtYXQ/OiBudW1iZXJcbiAgICApOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aW1lKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb252ZXJ0ZWRUaW1lID0gdGhpcy5wYXJzZVRpbWUodGltZSwge2Zvcm1hdH0pO1xuICAgICAgICBjb25zdCBtaW51dGVzID0gY29udmVydGVkVGltZS5taW51dGU7XG5cbiAgICAgICAgaWYgKG1pbnV0ZXNHYXAgJiYgbWludXRlcyA9PT0gbWludXRlcyAmJiBtaW51dGVzICUgbWludXRlc0dhcCAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3VyIG1pbnV0ZXMgLSAke21pbnV0ZXN9IGRvZXNuXFwndCBtYXRjaCB5b3VyIG1pbnV0ZXNHYXAgLSAke21pbnV0ZXNHYXB9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaXNBZnRlciA9IChtaW4gJiYgIW1heClcbiAgICAgICAgICAgICYmIGlzU2FtZU9yQWZ0ZXIoY29udmVydGVkVGltZSwgbWluLCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGlzQmVmb3JlID0gKG1heCAmJiAhbWluKVxuICAgICAgICAgICAgJiYgaXNTYW1lT3JCZWZvcmUoY29udmVydGVkVGltZSwgbWF4LCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGJldHdlZW4gPSAobWluICYmIG1heClcbiAgICAgICAgICAgICYmIGlzQmV0d2Vlbihjb252ZXJ0ZWRUaW1lLCBtaW4sIG1heCwgZ3JhbnVsYXJpdHkpO1xuICAgICAgICBjb25zdCBpc0F2YWlsYWJsZSA9ICFtaW4gJiYgIW1heDtcblxuICAgICAgICByZXR1cm4gaXNBZnRlciB8fCBpc0JlZm9yZSB8fCBiZXR3ZWVuIHx8IGlzQXZhaWxhYmxlO1xuICAgIH1cblxuICAgIC8qKipcbiAgICAgKiAgRm9ybWF0IGhvdXIgYWNjb3JkaW5nIHRvIHRpbWUgZm9ybWF0ICgxMiBvciAyNClcbiAgICAgKi9cbiAgICBzdGF0aWMgZm9ybWF0SG91cihjdXJyZW50SG91cjogbnVtYmVyLCBmb3JtYXQ6IG51bWJlciwgcGVyaW9kOiBUaW1lUGVyaW9kKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKGZvcm1hdCA9PT0gMjQpIHtcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50SG91cjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBob3VyID0gcGVyaW9kID09PSBUaW1lUGVyaW9kLkFNID8gY3VycmVudEhvdXIgOiBjdXJyZW50SG91ciArIDEyO1xuXG4gICAgICAgIGlmIChwZXJpb2QgPT09IFRpbWVQZXJpb2QuQU0gJiYgaG91ciA9PT0gMTIpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9IGVsc2UgaWYgKHBlcmlvZCA9PT0gVGltZVBlcmlvZC5QTSAmJiBob3VyID09PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIDEyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBob3VyO1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tRGF0ZVRpbWVUb1N0cmluZyh0aW1lOiBEYXRlVGltZSwgZm9ybWF0OiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB0aW1lRm9ybWF0ID0gZm9ybWF0ID09PSAyNCA/IFRpbWVGb3JtYXQuVFdFTlRZX0ZPVVIgOiBUaW1lRm9ybWF0LlRXRUxWRTtcblxuICAgICAgICByZXR1cm4gdGltZS5yZWNvbmZpZ3VyZSh7XG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IFRpbWVBZGFwdGVyLkRFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTSxcbiAgICAgICAgICAgIGxvY2FsZTogVGltZUFkYXB0ZXIuREVGQVVMVF9MT0NBTEVcbiAgICAgICAgfSkudG9Gb3JtYXQodGltZUZvcm1hdCkucmVwbGFjZSgvXFx1MjAyRi9nLCAnICcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldExvY2FsZU9wdGlvbnNCeVRpbWUodGltZTogc3RyaW5nLCBvcHRzOiBUaW1lT3B0aW9ucyk6IExvY2FsZU9wdGlvbnMge1xuICAgICAgICBjb25zdCBsb2NhbGVDb25maWc6IExvY2FsZU9wdGlvbnMgPSB7bnVtYmVyaW5nU3lzdGVtOiBvcHRzLm51bWJlcmluZ1N5c3RlbSwgbG9jYWxlOiBvcHRzLmxvY2FsZX07XG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb25maWc6IExvY2FsZU9wdGlvbnMgPSB7bnVtYmVyaW5nU3lzdGVtOiBUaW1lQWRhcHRlci5ERUZBVUxUX05VTUJFUklOR19TWVNURU0sIGxvY2FsZTogVGltZUFkYXB0ZXIuREVGQVVMVF9MT0NBTEV9O1xuXG4gICAgICAgIHJldHVybiBpc05hTihwYXJzZUludCh0aW1lLCAxMCkpID8gbG9jYWxlQ29uZmlnIDogZGVmYXVsdENvbmZpZztcbiAgICB9XG59XG4iXX0=